<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Night Randomizer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-color: #f39c12;
            --secondary-bg: #2c3e50;
            --wheel-border: #ecf0f1;
            --btn-hover: #e67e22;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { margin-bottom: 5px; text-align: center; color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px;}
        p.subtitle { color: #aaa; margin-bottom: 20px; font-size: 0.9rem;}

        /* Alerts */
        .alert-banner {
            background: #c0392b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            max-width: 90%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            background: rgba(44, 62, 80, 0.98);
            padding: 30px;
            border-radius: 12px;
            z-index: 100;
            border: 1px solid var(--accent-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
            text-align: center;
            min-width: 250px;
        }

        .loading-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: transparent;
            border: 1px solid white;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .loading-btn:hover { background: rgba(255,255,255,0.1); }

        /* Wheel Container */
        .wheel-container {
            position: relative;
            width: 90vw;
            height: 90vw;
            max-width: 400px;
            max-height: 400px;
            margin-bottom: 30px;
        }

        canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0; 
            height: 0; 
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 45px solid var(--accent-color);
            z-index: 10;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
        }

        #spin-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--secondary-bg);
            color: var(--secondary-bg);
            font-weight: 800;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            z-index: 5;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        #spin-btn:hover:not(:disabled) { background: #eee; transform: translate(-50%, -50%) scale(1.05); }
        #spin-btn:active:not(:disabled) { transform: translate(-50%, -50%) scale(0.95); }
        #spin-btn:disabled { background: #555; border-color: #333; color: #888; cursor: not-allowed; }

        #result {
            font-size: 1.8rem;
            font-weight: bold;
            min-height: 50px;
            color: var(--accent-color);
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            padding: 0 20px;
        }

        .controls {
            background: var(--secondary-bg);
            padding: 25px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label { 
            font-weight: 600; 
            font-size: 0.9rem; 
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .genre-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .genre-btn {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            color: #bdc3c7;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .genre-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        
        .genre-btn.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: #1a1a1a;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.4);
        }

        .select-wrapper { position: relative; }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            appearance: none;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        select:focus { outline: none; border-color: var(--accent-color); }
        
        .select-wrapper::after {
            content: 'â–¼';
            font-size: 0.8rem;
            color: var(--accent-color);
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        
        .stats {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: right;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>

    <h1>Movie Night</h1>
    <p class="subtitle">Spin the wheel to decide your destiny</p>

    <div id="loading">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-circle-notch fa-spin"></i> 
            <span id="loading-text">Connecting to Sheet...</span>
        </div>
        <button class="loading-btn" onclick="useFallbackData()">Switch to Demo Mode</button>
    </div>

    <!-- Fallback Alert -->
    <div id="error-banner" class="alert-banner">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-wifi" style="opacity:0.7"></i> 
            <span>Connection failed. Using demo data.</span>
        </div>
        <button onclick="this.parentElement.style.display='none'" style="background:none; border:none; color:white; cursor:pointer;">&times;</button>
    </div>

    <div class="wheel-container">
        <div class="pointer"></div>
        <canvas id="wheel" width="800" height="800"></canvas>
        <button id="spin-btn" disabled>SPIN</button>
    </div>

    <div id="result"></div>

    <div class="controls">
        <div class="control-group">
            <label>Filter by Decade</label>
            <div class="select-wrapper">
                <select id="decade-select" disabled>
                    <option value="all">Any Decade</option>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label>Filter by Genre</label>
            <div class="genre-buttons" id="genre-container">
                <button class="genre-btn active" data-value="all">Any</button>
            </div>
        </div>
        <div class="stats">
            <span id="source-indicator">Source: ...</span>
            <span id="stats">0 movies loaded</span>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // I have hardcoded the CORRECT .csv link here so you don't need to change it
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS07Hxb1s2IZUKgDcYrpIQvin7s8xZj46omcGPmg1JyHNnRWRQVvpOiDppxhlTvPMdzrSpFRHx9W8vS/pub?output=csv';
        
        // Fallback data if Google Sheets is blocked
        const FALLBACK_MOVIES = [
            { Title: "The Matrix", Genre: "Sci-Fi", Year: "1999" },
            { Title: "The Godfather", Genre: "Crime", Year: "1972" },
            { Title: "Pulp Fiction", Genre: "Crime", Year: "1994" },
            { Title: "Inception", Genre: "Sci-Fi", Year: "2010" },
            { Title: "Toy Story", Genre: "Animation", Year: "1995" },
            { Title: "Parasite", Genre: "Thriller", Year: "2019" },
            { Title: "Interstellar", Genre: "Sci-Fi", Year: "2014" },
            { Title: "Gladiator", Genre: "Action", Year: "2000" },
            { Title: "Back to the Future", Genre: "Sci-Fi", Year: "1985" },
            { Title: "The Dark Knight", Genre: "Action", Year: "2008" },
            { Title: "Spirited Away", Genre: "Animation", Year: "2001" },
            { Title: "Psycho", Genre: "Horror", Year: "1960" },
            { Title: "Casablanca", Genre: "Romance", Year: "1942" },
            { Title: "Alien", Genre: "Sci-Fi", Year: "1979" },
            { Title: "Die Hard", Genre: "Action", Year: "1988" }
        ];

        // --- STATE VARIABLES ---
        let movies = [];
        let filteredMovies = [];
        let currentFilters = { genre: 'all', decade: 'all' };
        
        // --- DOM ELEMENTS ---
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spin-btn');
        const resultDisplay = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const decadeSelect = document.getElementById('decade-select');
        const genreContainer = document.getElementById('genre-container');
        const statsDiv = document.getElementById('stats');
        const errorBanner = document.getElementById('error-banner');
        const sourceIndicator = document.getElementById('source-indicator');

        // --- WHEEL VARIABLES ---
        let startAngle = 0;
        let arc = 0;
        let spinTimeout = null;
        let spinAngleStart = 0;
        let spinTime = 0;
        let spinTimeTotal = 0;
        let isSpinning = false;
        
        const colors = [
            "#e74c3c", "#3498db", "#9b59b6", "#16a085", 
            "#f1c40f", "#e67e22", "#d35400", "#2ecc71",
            "#1abc9c", "#8e44ad", "#2980b9", "#c0392b"
        ];

        // --- 1. DATA FETCHING ---
        async function initApp() {
            try {
                // Auto-correct URL if user pasted the HTML link instead of CSV
                let url = SHEET_CSV_URL;
                if (url.includes('/pubhtml')) {
                    url = url.replace('/pubhtml', '/pub?output=csv');
                }

                loadingText.textContent = "Fetching Data...";

                // Setup AbortController for 5 second timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                // Attempt to fetch live data
                const response = await fetch(url, { 
                    cache: "no-store",
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                const csvText = await response.text();
                
                // Validate Content
                if (csvText.trim().startsWith("<!DOCTYPE html") || csvText.includes("<html")) {
                    throw new Error("Received HTML instead of CSV (likely CORS/Auth redirect)");
                }

                movies = parseCSV(csvText);
                if(movies.length === 0) throw new Error("Parsed data is empty");

                // Success!
                sourceIndicator.textContent = "Source: Live Google Sheet";
                sourceIndicator.style.color = "#2ecc71"; // Green
                finalizeInit();

            } catch (err) {
                console.warn("Live fetch failed, switching to fallback:", err);
                useFallbackData();
            }
        }

        function useFallbackData() {
            movies = FALLBACK_MOVIES;
            errorBanner.style.display = 'flex';
            sourceIndicator.textContent = "Source: Demo Data";
            sourceIndicator.style.color = "#e74c3c"; // Red
            finalizeInit();
        }

        function finalizeInit() {
            populateControls();
            loadingDiv.style.display = 'none';
            spinBtn.disabled = false;
            decadeSelect.disabled = false;
            filterMovies(); 
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            if (lines.length < 2) return [];

            const headers = parseCSVRow(lines[0]).map(h => h.trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const rowValues = parseCSVRow(lines[i]);
                const entry = {};
                
                headers.forEach((header, index) => {
                    const cleanHeader = header.replace(/^"|"$/g, '');
                    let val = rowValues[index] || '';
                    val = val.trim().replace(/^"|"$/g, '');
                    entry[cleanHeader] = val;
                });

                if(entry.Title) data.push(entry);
            }
            return data;
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') { inQuotes = !inQuotes; } 
                else if (char === ',' && !inQuotes) { result.push(current); current = ''; } 
                else { current += char; }
            }
            result.push(current);
            return result;
        }

        // --- 2. CONTROLS ---
        function populateControls() {
            genreContainer.innerHTML = '';
            const allBtn = document.createElement('button');
            allBtn.className = 'genre-btn active';
            allBtn.textContent = 'Any';
            allBtn.dataset.value = 'all';
            allBtn.onclick = () => selectGenre(allBtn, 'all');
            genreContainer.appendChild(allBtn);

            const genres = new Set();
            movies.forEach(m => { if(m.Genre) genres.add(m.Genre); });
            
            Array.from(genres).sort().forEach(genre => {
                const btn = document.createElement('button');
                btn.className = 'genre-btn';
                btn.textContent = genre;
                btn.dataset.value = genre;
                btn.onclick = () => selectGenre(btn, genre);
                genreContainer.appendChild(btn);
            });

            // Clear previous options except first
            while(decadeSelect.options.length > 1) { decadeSelect.remove(1); }

            const decades = new Set();
            movies.forEach(m => {
                const y = parseInt(m.Year);
                if (!isNaN(y)) decades.add(Math.floor(y / 10) * 10);
            });
            
            Array.from(decades).sort((a,b) => b - a).forEach(decade => {
                const option = document.createElement('option');
                option.value = decade;
                option.textContent = `${decade}s`;
                decadeSelect.appendChild(option);
            });
            
            // Re-attach listeners just in case
            spinBtn.onclick = spin; 
            decadeSelect.onchange = (e) => {
                currentFilters.decade = e.target.value;
                filterMovies();
            };
        }

        function selectGenre(clickedBtn, genre) {
            document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
            clickedBtn.classList.add('active');
            currentFilters.genre = genre;
            filterMovies();
        }

        // --- 3. FILTER & DRAW ---
        function filterMovies() {
            filteredMovies = movies.filter(movie => {
                const movieYear = parseInt(movie.Year);
                const movieDecade = Math.floor(movieYear / 10) * 10;
                const matchGenre = currentFilters.genre === 'all' || movie.Genre === currentFilters.genre;
                const matchDecade = currentFilters.decade === 'all' || movieDecade.toString() === currentFilters.decade;
                return matchGenre && matchDecade;
            });

            statsDiv.textContent = `${filteredMovies.length} movies in rotation`;

            if (filteredMovies.length === 0) {
                resultDisplay.textContent = "No movies found!";
                spinBtn.disabled = true;
                drawEmptyWheel();
            } else {
                resultDisplay.textContent = "";
                spinBtn.disabled = false;
                startAngle = 0;
                drawWheel();
            }
        }

        function drawWheel() {
            if (filteredMovies.length === 0) return;
            const outsideRadius = 380;
            const textRadius = 300;
            const insideRadius = 70;
            
            ctx.clearRect(0,0,800,800);
            arc = Math.PI * 2 / filteredMovies.length;
            
            for(let i = 0; i < filteredMovies.length; i++) {
                const angle = startAngle + i * arc;
                ctx.fillStyle = colors[i % colors.length];
                ctx.beginPath();
                ctx.arc(400, 400, outsideRadius, angle, angle + arc, false);
                ctx.arc(400, 400, insideRadius, angle + arc, angle, true);
                ctx.stroke();
                ctx.fill();
                
                ctx.save();
                ctx.fillStyle = "white";
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 4;
                const fontSize = filteredMovies.length > 20 ? 18 : 24;
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.translate(400 + Math.cos(angle + arc / 2) * textRadius, 
                              400 + Math.sin(angle + arc / 2) * textRadius);
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                let text = filteredMovies[i].Title;
                if(text.length > 18) text = text.substring(0, 16) + "...";
                ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
                ctx.restore();
            }
            
            ctx.beginPath();
            ctx.arc(400, 400, insideRadius, 0, Math.PI*2);
            ctx.strokeStyle = "#2c3e50";
            ctx.lineWidth = 15;
            ctx.stroke();
        }

        function drawEmptyWheel() {
            ctx.clearRect(0,0,800,800);
            ctx.beginPath();
            ctx.arc(400, 400, 380, 0, Math.PI*2);
            ctx.strokeStyle = "#444";
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = "#666";
            ctx.font = "30px Arial";
            ctx.textAlign = "center";
            ctx.fillText("No Movies", 400, 400);
        }

        // --- 4. ANIMATION ---
        function spin() {
            if (isSpinning || filteredMovies.length === 0) return;
            isSpinning = true;
            spinBtn.disabled = true;
            resultDisplay.textContent = "";
            spinAngleStart = Math.random() * 10 + 10;
            spinTime = 0;
            spinTimeTotal = Math.random() * 3000 + 4000;
            rotateWheel();
        }

        function rotateWheel() {
            spinTime += 30;
            if(spinTime >= spinTimeTotal) {
                stopRotateWheel();
                return;
            }
            const spinAngle = spinAngleStart - (easeOut(spinTime, 0, spinAngleStart, spinTimeTotal));
            startAngle += (spinAngle * Math.PI / 180);
            drawWheel();
            spinTimeout = requestAnimationFrame(rotateWheel);
        }

        function stopRotateWheel() {
            cancelAnimationFrame(spinTimeout);
            isSpinning = false;
            spinBtn.disabled = false;
            const degrees = startAngle * 180 / Math.PI + 90;
            const arcd = arc * 180 / Math.PI;
            const index = Math.floor((360 - degrees % 360) / arcd);
            
            ctx.save();
            const text = filteredMovies[index].Title;
            resultDisplay.innerHTML = `<span style="color:white">Winner:</span> ${text}`;
            ctx.restore();
        }

        function easeOut(t, b, c, d) {
            const ts = (t/=d)*t;
            const tc = ts*t;
            return b+c*(tc + -3*ts + 3*t);
        }

        initApp();
    </script>
</body>
</html>